---
title: "Exploring `packrat`"
author: "Roy Storey"
date: "1/8/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, verbose = TRUE, progress = TRUE)
library(dplyr)
```

## Description

[packrat](http://rstudio.github.io/packrat/) is a package manager for R, much like pip for Python, cpanminus for perl, Bundler for Ruby gems, npm for node and yarn for javascript. Each of these package managers share a common goal of reproducibly installing an environment in which to run a user's code. Most allow for specification of the name and version of a list dependencies in a single file.

```{r compare, echo = FALSE}
manager <- c("packrat", "pip", "cpanminus", "bundler", "npm", "yarn")
language <- c("R", "Python", "Perl", "Ruby", "NodeJS", "Javascript")
entity <- c("packages", "modules", "modules", "gems", "packages", "packages")
spec_file <- c("`packrat.lock`", "`requirements.txt`", "`cpanfile`", "`Gemfile`", "`package.json`", "`package.json`")
t <- data.frame(manager, language, entity, spec_file)
knitr::kable(t)
```

## Usage

Some of these steps are manual in other languages.

* [walkthrough](http://rstudio.github.io/packrat/walkthrough.html)

### Initialisation

```{r init, eval = FALSE, highlight = TRUE}
packrat::init()
```

### Installation

#### From an authored `packrat.lock`

```{r install-packrat, eval = FALSE}
packrat::restore()
```

#### While developing

```{r install-develop, eval = FALSE}
install.packages(dplyr)
packrat::snapshot()
```

### State

```{r status, eval = FALSE}
packrat::status()
```

#### Save

```{r save, eval = FALSE}
packrat::snapshot()
```

### What is installed?

```{r what-is-installed, echo = FALSE, results = 'markup', message = FALSE, warning = FALSE}
libraries    <- library(lib.loc=NULL)
libraries.df <- data.frame(
  Package     = libraries$results[,"Package"],
  Version     = NA,
  Title       = gsub("\\n|\\r", " ", libraries$results[,"Title"], fixed = FALSE, perl = TRUE),
  Built       = NA,
  Repo        = NA,
  LibPath     = libraries$results[,"LibPath"]
)

for(i in seq(nrow(libraries.df))) {
  ## What package?
  pkg     <- as.character(libraries.df$Package[i])

  ## Package version
  Version <- as.character(packageVersion(pkg, lib.loc=libraries.df$LibPath[i]))

  ## packageDescription elements to add...
  pkgDesc <- packageDescription(pkg, lib.loc=libraries.df$LibPath[i])

  Built       <- pkgDesc$Built
  Repo        <- pkgDesc$Repository

  libraries.df$Version[i]       <- Version
  if(!is.null(Built)) {
    libraries.df$Built[i]       <- Built
  }
  if(!is.null(Repo)) {
    libraries.df$Repo[i]        <- Repo
  }
}
# finally make path relative.
project_dir <- packrat::project_dir()
libraries.df$LibPath <- gsub(project_dir, ".", libraries.df$LibPath, fixed = TRUE)

knitr::kable(libraries.df, align=c('l'), format = "html")
```
